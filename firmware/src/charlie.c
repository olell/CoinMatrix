/**
 * matrix structure
 *
 *   0 1 2 3 4 ...
 * 0 x
 * 1   x
 * 2     x
 * 3       x
 * 4         x
 * ...
 */

#include "charlie.h"

#include "ch32fun.h"
#include "stdio.h"

// by "charlie_paramgen.py" precalculated values
#define CHARLIE_CYCLE_COUNT 192
const uint32_t charlie_gpioc_cfglr[CHARLIE_CYCLE_COUNT] = {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x20000000, 0x02000000, 0x00200000, 0x00000200, 0x00000002, 0x00000020, 0x00002000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x20000000, 0x02000000, 0x00200000, 0x00000200, 0x00000002, 0x00000020, 0x00002000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x20000000, 0x02000000, 0x00200000, 0x00000200, 0x00000002, 0x00000020, 0x00002000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x20000000, 0x02000000, 0x00200000, 0x00000200, 0x00000002, 0x00000020, 0x00002000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x20000000, 0x02000000, 0x00200000, 0x00000200, 0x00000002, 0x00000020, 0x00002000, 0x00000000, 0x20000000, 0x20000000, 0x20000000, 0x20000000, 0x20000000, 0x22000000, 0x20200000, 0x20000200, 0x20000002, 0x20000020, 0x20002000, 0x20000000, 0x02000000, 0x02000000, 0x02000000, 0x02000000, 0x02000000, 0x22000000, 0x02200000, 0x02000200, 0x02000002, 0x02000020, 0x02002000, 0x02000000, 0x00200000, 0x00200000, 0x00200000, 0x00200000, 0x00200000, 0x20200000, 0x02200000, 0x00200200, 0x00200002, 0x00200020, 0x00202000, 0x00200000, 0x00000200, 0x00000200, 0x00000200, 0x00000200, 0x00000200, 0x20000200, 0x02000200, 0x00200200, 0x00000202, 0x00000220, 0x00002200, 0x00000200, 0x00000002, 0x00000002, 0x00000002, 0x00000002, 0x00000002, 0x20000002, 0x02000002, 0x00200002, 0x00000202, 0x00000022, 0x00002002, 0x00000002, 0x00000020, 0x00000020, 0x00000020, 0x00000020, 0x00000020, 0x20000020, 0x02000020, 0x00200020, 0x00000220, 0x00000022, 0x00002020, 0x00000020, 0x00002000, 0x00002000, 0x00002000, 0x00002000, 0x00002000, 0x20002000, 0x02002000, 0x00202000, 0x00002200, 0x00002002, 0x00002020, 0x00002000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x20000000, 0x02000000, 0x00200000, 0x00000200, 0x00000002, 0x00000020, 0x00002000, 0x00020000, 0x00020000, 0x00020000, 0x00020000, 0x00020000, 0x20020000, 0x02020000, 0x00220000, 0x00020200, 0x00020002, 0x00020020, 0x00022000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x20000000, 0x02000000, 0x00200000, 0x00000200, 0x00000002, 0x00000020, 0x00002000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x20000000, 0x02000000, 0x00200000, 0x00000200, 0x00000002, 0x00000020, 0x00002000};
const uint32_t charlie_gpiod_cfglr[CHARLIE_CYCLE_COUNT] = {0x02200000, 0x02020000, 0x02002000, 0x02000200, 0x02000000, 0x02000000, 0x02000000, 0x02000000, 0x02000000, 0x02000000, 0x02000000, 0x02000020, 0x02200000, 0x00220000, 0x00202000, 0x00200200, 0x00200000, 0x00200000, 0x00200000, 0x00200000, 0x00200000, 0x00200000, 0x00200000, 0x00200020, 0x02020000, 0x00220000, 0x00022000, 0x00020200, 0x00020000, 0x00020000, 0x00020000, 0x00020000, 0x00020000, 0x00020000, 0x00020000, 0x00020020, 0x02002000, 0x00202000, 0x00022000, 0x00002200, 0x00002000, 0x00002000, 0x00002000, 0x00002000, 0x00002000, 0x00002000, 0x00002000, 0x00002020, 0x02000200, 0x00200200, 0x00020200, 0x00002200, 0x00000200, 0x00000200, 0x00000200, 0x00000200, 0x00000200, 0x00000200, 0x00000200, 0x00000220, 0x02000000, 0x00200000, 0x00020000, 0x00002000, 0x00000200, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000020, 0x02000000, 0x00200000, 0x00020000, 0x00002000, 0x00000200, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000020, 0x02000000, 0x00200000, 0x00020000, 0x00002000, 0x00000200, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000020, 0x02000000, 0x00200000, 0x00020000, 0x00002000, 0x00000200, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000020, 0x02000000, 0x00200000, 0x00020000, 0x00002000, 0x00000200, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000020, 0x02000000, 0x00200000, 0x00020000, 0x00002000, 0x00000200, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000020, 0x02000000, 0x00200000, 0x00020000, 0x00002000, 0x00000200, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000020, 0x02000020, 0x00200020, 0x00020020, 0x00002020, 0x00000220, 0x00000020, 0x00000020, 0x00000020, 0x00000020, 0x00000020, 0x00000020, 0x00000020, 0x02000000, 0x00200000, 0x00020000, 0x00002000, 0x00000200, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x22000000, 0x20200000, 0x20020000, 0x20002000, 0x20000200, 0x20000000, 0x20000000, 0x20000000, 0x20000000, 0x20000000, 0x20000000, 0x20000000, 0x02000002, 0x00200002, 0x00020002, 0x00002002, 0x00000202, 0x00000002, 0x00000002, 0x00000002, 0x00000002, 0x00000002, 0x00000002, 0x00000002};
const uint32_t charlie_out_regs[CHARLIE_CYCLE_COUNT] = {0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001100c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c, 0x4001140c};
const uint8_t charlie_out_vals[CHARLIE_CYCLE_COUNT] = {0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01};

uint8_t raw_pixels[CHARLIE_CYCLE_COUNT];

void charlieSetPixelRaw(int px, uint8_t v) {
    raw_pixels[px] = v;
}

uint8_t charlieGetPixelRaw(int px) {
    return raw_pixels[px];
}

void charlieSetup() {
    // Convert PD1 from SWIO to GPIO
    AFIO->PCFR1 &= ~(AFIO_PCFR1_SWCFG);
    AFIO->PCFR1 |= AFIO_PCFR1_SWCFG_DISABLE;
}

uint_fast32_t idx = 0;

inline void charlieDisplay() __attribute__((section(".srodata"))) __attribute__((used)) __attribute__((always_inline));
inline void charlieDisplay() {

    GPIOC->CFGLR = charlie_gpioc_cfglr[idx];
    GPIOD->CFGLR = charlie_gpiod_cfglr[idx];

    register uint32_t *out_reg asm ("a1") = (uint32_t*)charlie_out_regs[idx];
    register const uint_fast8_t out_val asm("a2") = charlie_out_vals[idx];

    register const uint_fast8_t pwm asm("a3") = raw_pixels[idx];

    for (register uint8_t tmp asm ("a4"); tmp < CHARLIE_MAX_BRIGHTNESS; tmp++) {
        *(out_reg) = (tmp < pwm) ? out_val : 0;
    }

    if (++idx == CHARLIE_CYCLE_COUNT) idx = 0;
}